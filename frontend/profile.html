<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - PharmaCare</title>
    <link rel="stylesheet" href="/styles.css">
  </head>
  <body>
    <header class="navbar">
      <div class="container">
        <div class="nav-left">
          <h1 class="logo">üíä PharmaCare</h1>
          <nav class="nav-links">
            <a href="/">–ú–∞–≥–∞–∑–∏–Ω</a>
            <a href="/admin" class="admin-link">–ê–¥–º–∏–Ω</a>
          </nav>
        </div>
        <div class="nav-right">
          <div id="user-status"></div>
          <button id="logout-btn" class="btn-logout">–í—ã—Ö–æ–¥</button>
        </div>
      </div>
    </header>

    <main>
      <div class="profile-container">
        <div class="profile-sidebar">
          <div class="profile-card">
            <h3>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h3>
            <div id="profile-info"></div>
            <button id="edit-profile-btn" class="btn-edit-profile" style="width:100%;margin-top:1rem">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
          <div id="edit-profile-form" class="profile-card" style="display:none;margin-top:1rem">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h3>
            <input type="text" id="edit-name" placeholder="–ò–º—è" style="width:100%;padding:0.8rem;margin-bottom:0.8rem;border:1px solid #d1d5db;border-radius:6px;box-sizing:border-box" />
            <input type="tel" id="edit-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω: +7 (999) 123-45-67" style="width:100%;padding:0.8rem;margin-bottom:0.8rem;border:1px solid #d1d5db;border-radius:6px;box-sizing:border-box" />
            <textarea id="edit-address" placeholder="–ê–¥—Ä–µ—Å: –ì–æ—Ä–æ–¥, —É–ª. –ü—É—à–∫–∏–Ω–∞, –¥. 10, –∫–≤. 5" style="width:100%;padding:0.8rem;margin-bottom:0.8rem;border:1px solid #d1d5db;border-radius:6px;box-sizing:border-box;min-height:80px;font-family:inherit"></textarea>
            <div class="profile-field" style="border-bottom:none;font-size:0.9rem;margin-bottom:0.8rem"><strong>Email (–Ω–µ –º–µ–Ω—è–µ—Ç—Å—è)</strong> <span id="edit-email-display"></span></div>
            <button id="save-profile-btn" class="btn-save-profile" style="width:100%;padding:0.8rem;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin-bottom:0.5rem">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="cancel-profile-btn" style="width:100%;padding:0.8rem;background:#6b7280;color:white;border:none;border-radius:6px;cursor:pointer">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>

        <div class="profile-content">
          <h2>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
          <div id="orders" class="orders-list"></div>
        </div>
      </div>
    </main>

    <script>
      const API_ORDERS = 'http://localhost:3003'
      const API_USERS = 'http://localhost:3002'
      
      function token(){return localStorage.getItem('token')}
      
      if(!token()) window.location.href = '/login.html'
      
      document.getElementById('logout-btn').addEventListener('click', ()=>{
        localStorage.removeItem('token')
        window.location.href = '/'
      })
      
      let currentUser = null
      
      async function loadProfile(){
        const res = await fetch(`${API_USERS}/me`,{
          headers:{'Authorization':'Bearer '+token()}
        })
        if(res.ok){
          currentUser = await res.json()
          document.getElementById('profile-info').innerHTML = `
            <div class="profile-field"><strong>Email:</strong> ${currentUser.email}</div>
            <div class="profile-field"><strong>–ò–º—è:</strong> ${currentUser.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
            <div class="profile-field"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${currentUser.phone || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
            <div class="profile-field"><strong>–ê–¥—Ä–µ—Å:</strong> ${currentUser.address || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
          `
          
          // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          document.getElementById('edit-name').value = currentUser.name || ''
          document.getElementById('edit-phone').value = currentUser.phone || ''
          document.getElementById('edit-address').value = currentUser.address || ''
          document.getElementById('edit-email-display').textContent = currentUser.email
        }
      }
      
      async function loadOrders(){
        const res = await fetch(`${API_ORDERS}/orders`)
        if(res.ok){
          const allOrders = await res.json()
          const userToken = token()
          const user = await fetch(`${API_USERS}/me`,{
            headers:{'Authorization':'Bearer '+userToken}
          }).then(r=>r.json())
          
          const myOrders = allOrders.filter(o=>o.user_id === user.sub)
          const container = document.getElementById('orders')
          
          if(myOrders.length === 0){
            container.innerHTML = '<div class="empty-state">–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>'
            return
          }
          
          container.innerHTML = ''
          myOrders.forEach(order=>{
            const card = document.createElement('div')
            card.className = 'order-card'
            const date = new Date(order.created_at).toLocaleString('ru-RU')
            const status = order.status === 'pending' ? '‚è≥ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ' : order.status === 'placed' ? 'üìã –û—Ñ–æ—Ä–º–ª–µ–Ω' : '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω'
            const fulfillment = order.fulfillment === 'delivery' ? 'üöö –î–æ—Å—Ç–∞–≤–∫–∞' : 'üè™ –°–∞–º–æ–≤—ã–≤–æ–∑'
            const items = order.items || []
            const total = items.reduce((sum, item)=>sum + (item.price||0), 0)
            const totalFormatted = total.toFixed(2)
            
            card.innerHTML = `
              <div class="order-header">
                <div>
                  <strong>–ó–∞–∫–∞–∑ #${order.id}</strong>
                  <div class="order-date">${date}</div>
                </div>
                <div class="order-status">${status}</div>
              </div>
              <div class="order-details">
                <div><strong>–°–ø–æ—Å–æ–±:</strong> ${fulfillment}</div>
                <div><strong>–ö–æ–Ω—Ç–∞–∫—Ç:</strong> ${order.phone || order.email || 'N/A'}</div>
                <div><strong>–ê–¥—Ä–µ—Å:</strong> ${order.address || 'N/A'}</div>
              </div>
              <div class="order-items">
                <strong>–¢–æ–≤–∞—Ä—ã:</strong>
                ${items.map(item=>`<div class="order-item">üíä ${item.name || '–¢–æ–≤–∞—Ä'} - ${(item.price||0).toFixed(2)} ‚ÇΩ</div>`).join('')}
                <div class="order-total"><strong>–ò—Ç–æ–≥–æ: ${totalFormatted} ‚ÇΩ</strong></div>
              </div>
            `
            container.appendChild(card)
          })
        }
      }
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
      document.getElementById('edit-profile-btn').addEventListener('click', ()=>{
        document.getElementById('edit-profile-form').style.display = 'block'
        document.getElementById('edit-profile-btn').style.display = 'none'
      })
      
      document.getElementById('cancel-profile-btn').addEventListener('click', ()=>{
        document.getElementById('edit-profile-form').style.display = 'none'
        document.getElementById('edit-profile-btn').style.display = 'block'
      })
      
      document.getElementById('save-profile-btn').addEventListener('click', async ()=>{
        const name = document.getElementById('edit-name').value.trim()
        const phone = document.getElementById('edit-phone').value.trim()
        const address = document.getElementById('edit-address').value.trim()
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if(!name) {
          alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∏–º—è')
          return
        }
        if(!phone) {
          alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞')
          return
        }
        if(!address) {
          alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å')
          return
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        document.getElementById('save-profile-btn').disabled = true
        document.getElementById('save-profile-btn').textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...'
        
        try {
          const res = await fetch(`${API_USERS}/me`, {
            method: 'PATCH',
            headers: {
              'Authorization': 'Bearer ' + token(),
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({name, phone, address})
          })
          
          if(res.ok){
            console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω')
            document.getElementById('edit-profile-form').style.display = 'none'
            document.getElementById('edit-profile-btn').style.display = 'block'
            document.getElementById('save-profile-btn').disabled = false
            document.getElementById('save-profile-btn').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å'
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
            await loadProfile()
            alert('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!')
          } else {
            const errorText = await res.text()
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', errorText)
            document.getElementById('save-profile-btn').disabled = false
            document.getElementById('save-profile-btn').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å'
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (errorText || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å'))
          }
        } catch(e){
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', e)
          document.getElementById('save-profile-btn').disabled = false
          document.getElementById('save-profile-btn').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å'
          alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + e.message)
        }
      })
      
      loadProfile()
      loadOrders()
    </script>
  </body>
</html>
