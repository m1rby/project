<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ - PharmaCare</title>
    <link rel="stylesheet" href="/styles.css">
  </head>
  <body>
    <header class="navbar">
      <div class="container">
        <div class="nav-left">
          <h1 class="logo">üíä PharmaCare</h1>
          <nav class="nav-links">
            <a href="/">–ú–∞–≥–∞–∑–∏–Ω</a>
            <a href="/admin" class="admin-link">–ê–¥–º–∏–Ω</a>
          </nav>
        </div>
        <div class="nav-right">
          <div id="user-status"></div>
          <a href="/profile.html" class="profile-link">üë§</a>
        </div>
      </div>
    </header>

    <main>
      <div class="checkout-container">
        <div class="checkout-box">
          <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
          
          <div class="checkout-section">
            <h3>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h3>
            <div id="checkout-items" class="checkout-items"></div>
            <div class="checkout-total">
              <strong>–ò—Ç–æ–≥–æ:</strong> <span id="total">‚ÇΩ0</span>
            </div>
          </div>

          <div class="checkout-section">
            <h3>–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</h3>
            <div class="fulfillment-options">
              <label><input type="radio" name="fulfillment" value="delivery" checked /> üöö –î–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ –∞–¥—Ä–µ—Å</label>
              <label><input type="radio" name="fulfillment" value="pickup" /> üè™ –°–∞–º–æ–≤—ã–≤–æ–∑ –∏–∑ –∞–ø—Ç–µ–∫–∏</label>
            </div>
          </div>

          <!-- –î–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ –∞–¥—Ä–µ—Å -->
          <div id="delivery-section" class="checkout-section" style="display:block">
            <h3>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
            <input type="text" id="address" placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞" />
          </div>

          <!-- –°–∞–º–æ–≤—ã–≤–æ–∑ –∏–∑ –∞–ø—Ç–µ–∫–∏ -->
          <div id="pickup-section" class="checkout-section" style="display:none">
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∞–ø—Ç–µ–∫—É</h3>
            <select id="pharmacy-select" style="width:100%;padding:0.8rem;border:1px solid #d1d5db;border-radius:8px;font-size:1rem">
              <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∞–ø—Ç–µ–∫—É --</option>
            </select>
          </div>

          <div class="checkout-section">
            <h3>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
            <input type="text" id="full-name" placeholder="–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ" />
            <input type="tel" id="phone" placeholder="+7 (999) 123-45-67" />
            <input type="email" id="email" placeholder="email@example.com" />
          </div>

          <div class="checkout-section">
            <h3>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h3>
            <div class="fulfillment-options">
              <label><input type="radio" name="payment-method" value="card" checked /> üí≥ –ö–∞—Ä—Ç–∞ (–æ–Ω–ª–∞–π–Ω)</label>
              <label><input type="radio" name="payment-method" value="cash" /> üíµ –ù–∞–ª–∏—á–Ω—ã–µ –ø—Ä–∏ –¥–æ—Å—Ç–∞–≤–∫–µ</label>
            </div>
          </div>

          <button id="place-order" class="btn-place-order">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</button>
          <a href="/" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω</a>
          <div id="error" class="error-msg"></div>
          <div id="success-modal" class="modal" style="display:none">
            <div class="modal-content">
              <div class="modal-header">
                <h2>‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!</h2>
              </div>
              <div class="modal-body">
                <div id="order-details"></div>
              </div>
              <div class="modal-footer">
                <button id="close-modal-btn" class="btn-close-modal">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å</button>
              </div>
            </div>
          </div>

          <!-- Payment Modal -->
          <div id="payment-modal" class="modal" style="display:none">
            <div class="modal-content" style="max-width:500px">
              <div class="modal-header">
                <h2>üí≥ –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</h2>
              </div>
              <div class="modal-body">
                <div style="background:#f3f4f6;padding:1rem;border-radius:8px;margin-bottom:1.5rem">
                  <div style="font-size:0.9rem;color:#6b7280">–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ</div>
                  <div id="payment-amount" style="font-size:2rem;font-weight:bold;color:#10b981">0.00 ‚ÇΩ</div>
                </div>

                <div style="margin-bottom:1.5rem">
                  <label style="display:block;margin-bottom:0.5rem;font-weight:600">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</label>
                  <input type="text" id="card-number" placeholder="4111 1111 1111 1111" maxlength="19" style="width:100%;padding:0.8rem;border:1px solid #d1d5db;border-radius:6px;font-size:1rem;box-sizing:border-box" />
                  <div style="font-size:0.85rem;color:#6b7280;margin-top:0.3rem">–¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞: 4111111111111111</div>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem">
                  <div>
                    <label style="display:block;margin-bottom:0.5rem;font-weight:600">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</label>
                    <input type="text" id="card-expiry" placeholder="MM/YY" maxlength="5" style="width:100%;padding:0.8rem;border:1px solid #d1d5db;border-radius:6px;font-size:1rem;box-sizing:border-box" />
                  </div>
                  <div>
                    <label style="display:block;margin-bottom:0.5rem;font-weight:600">CVC</label>
                    <input type="text" id="card-cvc" placeholder="123" maxlength="3" style="width:100%;padding:0.8rem;border:1px solid #d1d5db;border-radius:6px;font-size:1rem;box-sizing:border-box" />
                  </div>
                </div>

                <div style="background:#fef3c7;border:1px solid #fcd34d;padding:1rem;border-radius:6px;margin-bottom:1.5rem;font-size:0.9rem;color:#92400e">
                  <strong>‚ÑπÔ∏è –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤—ã—à–µ. –ü–ª–∞—Ç–µ–∂ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.
                </div>
              </div>
              <div class="modal-footer">
                <button id="pay-cancel-btn" style="flex:1;padding:0.8rem;background:#6b7280;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin-right:0.5rem">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                <button id="pay-confirm-btn" style="flex:1;padding:0.8rem;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600">üí≥ –û–ø–ª–∞—Ç–∏—Ç—å</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      const API_ORDERS = 'http://localhost:3003'
      const API_PRODUCTS = 'http://localhost:3001'
      
      function token(){return localStorage.getItem('token')}
      
      if(!token()) {
        console.warn('‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞, —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥–∏–Ω')
        window.location.href = '/login.html'
      }
      
      // Get cart from sessionStorage (set by app.js)
      let cart = JSON.parse(sessionStorage.getItem('checkout_cart') || '[]')
      console.log('üì¶ –ö–æ—Ä–∑–∏–Ω–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', cart)
      
      if(!cart.length) {
        console.warn('‚ùå –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞')
        alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞! –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã.')
        window.location.href = '/'
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–ø—Ç–µ–∫–∏
      async function loadPharmacies(){
        try {
          const res = await fetch(`${API_PRODUCTS}/pharmacies`)
          if(!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–ø—Ç–µ–∫')
          const pharmacies = await res.json()
          const select = document.getElementById('pharmacy-select')
          if(select && pharmacies.length > 0) {
            pharmacies.forEach(ph => {
              const option = document.createElement('option')
              option.value = ph.address
              option.textContent = `${ph.name} - ${ph.address}`
              select.appendChild(option)
            })
            console.log('‚úÖ –ê–ø—Ç–µ–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', pharmacies.length)
          }
        } catch(e) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–ø—Ç–µ–∫:', e)
        }
      }
      
      function renderCheckout(){
        const items = document.getElementById('checkout-items')
        let total = 0
        items.innerHTML = ''
        
        if(!cart || cart.length === 0) {
          items.innerHTML = '<div style="padding:1rem;color:#ef4444">‚ö†Ô∏è –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>'
          document.getElementById('total').innerText = '0.00 ‚ÇΩ'
          return
        }
        
        cart.forEach(p => {
          const price = parseFloat(p.price) || 0
          total += price
          const item = document.createElement('div')
          item.className = 'checkout-item'
          item.innerHTML = `
            <div style="flex:1">
              <div style="font-weight:600">${p.name || '–¢–æ–≤–∞—Ä'}</div>
              <div style="font-size:0.9rem;color:#6b7280">${p.description || ''}</div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:600">${price.toFixed(2)} ‚ÇΩ</div>
            </div>
          `
          items.appendChild(item)
        })
        
        const totalFormatted = total.toFixed(2)
        document.getElementById('total').innerText = `${totalFormatted} ‚ÇΩ`
        console.log('‚úÖ –ö–æ—Ä–∑–∏–Ω–∞ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω–∞. –¢–æ–≤–∞—Ä–æ–≤:', cart.length, '–°—É–º–º–∞:', totalFormatted)
      }
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ø–æ—Å–æ–±–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
      function updateDeliveryForm(){
        const fulfillment = document.querySelector('input[name="fulfillment"]:checked').value
        const deliverySection = document.getElementById('delivery-section')
        const pickupSection = document.getElementById('pickup-section')
        
        if(fulfillment === 'delivery'){
          deliverySection.style.display = 'block'
          pickupSection.style.display = 'none'
        } else {
          deliverySection.style.display = 'none'
          pickupSection.style.display = 'block'
        }
        console.log('‚úÖ –§–æ—Ä–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞. –°–ø–æ—Å–æ–±:', fulfillment)
      }
      
      // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–ø–æ—Å–æ–±–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
      document.querySelectorAll('input[name="fulfillment"]').forEach(radio => {
        radio.addEventListener('change', updateDeliveryForm)
      })
      
      // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–∫–∞–∑–∞
      let currentOrder = null
      
      // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –∏ –ø–µ—Ä–µ—Ö–æ–¥ –∫ –æ–ø–ª–∞—Ç–µ
      document.getElementById('place-order').addEventListener('click', async ()=>{
        const fullName = document.getElementById('full-name').value.trim()
        const phone = document.getElementById('phone').value.trim()
        const email = document.getElementById('email').value.trim()
        const fulfillment = document.querySelector('input[name="fulfillment"]:checked').value
        const address = fulfillment === 'delivery' ? document.getElementById('address').value.trim() : ''
        const pharmacy = fulfillment === 'pickup' ? document.getElementById('pharmacy-select').value : ''
        const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if(!fullName) {
          alert('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –§–ò–û')
          return
        }
        if(!phone) {
          alert('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω')
          return
        }
        if(!email) {
          alert('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ email')
          return
        }
        if(fulfillment === 'delivery' && !address) {
          alert('‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏')
          return
        }
        if(fulfillment === 'pickup' && !pharmacy) {
          alert('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –∞–ø—Ç–µ–∫—É –¥–ª—è —Å–∞–º–æ–≤—ã–≤–æ–∑–∞')
          return
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞
        const total = cart.reduce((sum, p) => sum + (parseFloat(p.price) || 0), 0)
        currentOrder = {
          items: cart.map(p => ({productId: p.id, name: p.name, price: parseFloat(p.price) || 0})),
          fulfillment,
          phone,
          email,
          address: fulfillment === 'delivery' ? address : pharmacy,
          fullName,
          paymentMethod,
          total
        }
        
        console.log('ÔøΩ –î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:', currentOrder)
        
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –æ–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏ - –ø–µ—Ä–µ—Ö–æ–¥–∏–º –ø—Ä—è–º–æ –∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—é
        if(paymentMethod === 'cash') {
          await submitOrder(currentOrder)
          return
        }
        
        // –ï—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –æ–ø–ª–∞—Ç—ã
        document.getElementById('payment-amount').innerText = `${total.toFixed(2)} ‚ÇΩ`
        document.getElementById('payment-modal').style.display = 'flex'
      })
      
      // –û—Ç–º–µ–Ω–∞ –æ–ø–ª–∞—Ç—ã
      document.getElementById('pay-cancel-btn').addEventListener('click', ()=>{
        document.getElementById('payment-modal').style.display = 'none'
        document.getElementById('card-number').value = ''
        document.getElementById('card-expiry').value = ''
        document.getElementById('card-cvc').value = ''
      })
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã
      document.getElementById('pay-confirm-btn').addEventListener('click', async ()=>{
        const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '')
        const cardExpiry = document.getElementById('card-expiry').value
        const cardCvc = document.getElementById('card-cvc').value
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        if(!cardNumber || cardNumber.length < 13) {
          alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã')
          return
        }
        if(!cardExpiry || cardExpiry.length !== 5) {
          alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM/YY')
          return
        }
        if(!cardCvc || cardCvc.length !== 3) {
          alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ 3-–∑–Ω–∞—á–Ω—ã–π CVC')
          return
        }
        
        // –ò–º–∏—Ç–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞
        document.getElementById('pay-confirm-btn').disabled = true
        document.getElementById('pay-confirm-btn').textContent = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞...'
        
        console.log('üí≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞:', {
          card: cardNumber.slice(-4),
          expiry: cardExpiry,
          amount: currentOrder.total
        })
        
        // –ò–º–∏—Ç–∏—Ä—É–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞ (2 —Å–µ–∫—É–Ω–¥—ã)
        await new Promise(resolve => setTimeout(resolve, 2000))
        
        // –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Å–∏–≤—ã–π –∞–ª–µ—Ä—Ç
        showPaymentSuccessAlert(currentOrder)
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –æ–ø–ª–∞—Ç—ã
        document.getElementById('payment-modal').style.display = 'none'
        document.getElementById('pay-confirm-btn').disabled = false
        document.getElementById('pay-confirm-btn').textContent = 'üí≥ –û–ø–ª–∞—Ç–∏—Ç—å'
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        await submitOrder(currentOrder)
      })
      
      function showPaymentSuccessAlert(order) {
        const message = `
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  ‚úÖ –ü–õ–ê–¢–ï–ñ –£–°–ü–ï–®–ù–û –û–ë–†–ê–ë–û–¢–ê–ù!        ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                       ‚ïë
‚ïë  üí≥ –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:                    ‚ïë
‚ïë     –ö–∞—Ä—Ç–∞: ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 1111       ‚ïë
‚ïë                                       ‚ïë
‚ïë  üí∞ –°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞:                    ‚ïë
‚ïë     ${order.total.toFixed(2)} ‚ÇΩ
‚ïë                                       ‚ïë
‚ïë  üì¶ –°—Ç–∞—Ç—É—Å:                           ‚ïë
‚ïë     –í–∞—à –∑–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω!       ‚ïë
‚ïë     –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞         ‚ïë
‚ïë     ${order.email}
‚ïë                                       ‚ïë
‚ïë  üöö –î–æ—Å—Ç–∞–≤–∫–∞:                         ‚ïë
‚ïë     ${order.fulfillment === 'delivery' 
        ? '–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ\n     2-4 —á–∞—Å–æ–≤ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏'
        : '–¢–æ–≤–∞—Ä –≥–æ—Ç–æ–≤ –∫ —Å–∞–º–æ–≤—ã–≤–æ–∑—É\n     –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∞–ø—Ç–µ–∫–µ'}
‚ïë                                       ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        `
        alert(message)
      }
      
      async function submitOrder(order) {
        console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', order)
        
        try {
          const res = await fetch(`${API_ORDERS}/orders`, {
            method: 'POST',
            headers: {
              'content-type': 'application/json',
              'Authorization': 'Bearer ' + token()
            },
            body: JSON.stringify({
              items: order.items,
              fulfillment: order.fulfillment,
              phone: order.phone,
              email: order.email,
              address: order.address
            })
          })
          
          if(res.ok){
            const responseData = await res.json()
            console.log('‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω:', responseData)
            sessionStorage.removeItem('checkout_cart')
            sessionStorage.removeItem('checkout_fulfillment')
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏
            showSuccessModal(order, responseData)
          } else {
            const error = await res.text()
            console.error('‚ùå –û—à–∏–±–∫–∞:', error)
            document.getElementById('error').innerText = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: ' + res.status
          }
        } catch(e) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', e)
          document.getElementById('error').innerText = '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + e.message
        }
      }
      
      function showSuccessModal(order, responseData){
        const total = order.items.reduce((sum, item) => sum + (item.price || 0), 0)
        const totalFormatted = total.toFixed(2)
        const fulfillmentText = order.fulfillment === 'delivery' 
          ? `üöö –î–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ –∞–¥—Ä–µ—Å: ${order.address}`
          : `üè™ –°–∞–º–æ–≤—ã–≤–æ–∑ –∏–∑ –∞–ø—Ç–µ–∫–∏: ${order.address}`
        
        const itemsList = order.items
          .map(item => `<div style="margin:0.5rem 0">üíä ${item.name} - ${(item.price || 0).toFixed(2)} ‚ÇΩ</div>`)
          .join('')
        
        const detailedMessage = `
          <div style="text-align:left;background:#f0fdf4;padding:1.5rem;border-radius:8px;border:2px solid #10b981">
            <div style="margin-bottom:1.5rem">
              <h3 style="margin:0;color:#059669">üì¶ –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h3>
            </div>
            
            <div style="margin-bottom:1rem;padding:1rem;background:white;border-radius:6px;border-left:4px solid #10b981">
              <div style="font-size:0.9rem;color:#6b7280">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞</div>
              <div style="font-size:1.2rem;font-weight:bold;color:#1f2937">#${responseData.id}</div>
            </div>
            
            <div style="margin-bottom:1rem;padding:1rem;background:white;border-radius:6px;border-left:4px solid #10b981">
              <div style="font-size:0.9rem;color:#6b7280">–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏</div>
              <div style="font-size:1rem;font-weight:bold;color:#1f2937">${fulfillmentText}</div>
            </div>
            
            <div style="margin-bottom:1rem;padding:1rem;background:white;border-radius:6px;border-left:4px solid #10b981">
              <div style="font-size:0.9rem;color:#6b7280">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
              <div style="font-size:0.95rem;color:#1f2937">
                <div>üìû ${order.phone}</div>
                <div>üìß ${order.email}</div>
              </div>
            </div>
            
            <div style="margin-bottom:1rem;padding:1rem;background:white;border-radius:6px;border-left:4px solid #10b981">
              <div style="font-size:0.9rem;color:#6b7280">–¢–æ–≤–∞—Ä—ã (${order.items.length})</div>
              ${itemsList}
            </div>
            
            <div style="padding:1rem;background:#dbeafe;border-radius:6px;border-left:4px solid #3b82f6">
              <div style="font-size:0.9rem;color:#6b7280">–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ</div>
              <div style="font-size:1.5rem;font-weight:bold;color:#1e40af">${totalFormatted} ‚ÇΩ</div>
            </div>
            
            <div style="margin-top:1.5rem;padding:1rem;background:#fef3c7;border-radius:6px;border-left:4px solid #f59e0b;font-size:0.9rem;color:#92400e">
              <strong>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –í–∞—à –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —Å–∏—Å—Ç–µ–º—É –æ–±—Ä–∞–±–æ—Ç–∫–∏. ${
                order.fulfillment === 'delivery' 
                  ? '–°–ª—É–∂–±–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –Ω–æ–º–µ—Ä—É –≤ —Ç–µ—á–µ–Ω–∏–µ 2-4 —á–∞—Å–æ–≤.'
                  : '–ê–ø—Ç–µ–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞. –ó–∞–±–µ—Ä–∏—Ç–µ –µ–≥–æ –≤ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è.'
              }
            </div>
          </div>
        `
        
        document.getElementById('order-details').innerHTML = detailedMessage
        document.getElementById('success-modal').style.display = 'flex'
        
        document.getElementById('close-modal-btn').addEventListener('click', ()=>{
          window.location.href = '/profile.html'
        })
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è checkout...')
      renderCheckout()
      updateDeliveryForm()
      loadPharmacies()
    </script>
  </body>
</html>
